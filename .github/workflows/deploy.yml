name: Build and Deploy Backend JAR

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  JAVA_VERSION: '24'

jobs:
  build:
    name: Build JAR
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: Build JAR
      run: |
        echo "=== 构建 JAR 包（后端）==="
        mvn clean package -DskipTests

    - name: Verify JAR
      run: |
        if [ -f "target/BlobBackendService-1.0-SNAPSHOT.jar" ]; then
          echo "✅ JAR 包生成成功"
          ls -lh target/BlobBackendService-1.0-SNAPSHOT.jar
        else
          echo "❌ JAR 包未生成"
          exit 1
        fi

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: jar-artifact
        path: target/BlobBackendService-1.0-SNAPSHOT.jar
        retention-days: 7

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: jar-artifact
        path: artifacts/

    - name: Verify JAR before deploy
      run: |
        echo "=== 验证 JAR 文件 ==="
        echo "当前工作目录: $(pwd)"
        echo "检查 artifacts 目录..."
        ls -lah artifacts/ || echo "artifacts 目录不存在"
        if [ ! -f "artifacts/BlobBackendService-1.0-SNAPSHOT.jar" ]; then
          echo "❌ JAR 文件不存在: artifacts/BlobBackendService-1.0-SNAPSHOT.jar"
          echo "artifacts 目录内容:"
          ls -lah artifacts/ || echo "目录为空"
          exit 1
        fi
        echo "✅ JAR 文件存在"
        ls -lh artifacts/BlobBackendService-1.0-SNAPSHOT.jar
        file artifacts/BlobBackendService-1.0-SNAPSHOT.jar
        echo "JAR 文件大小: $(du -h artifacts/BlobBackendService-1.0-SNAPSHOT.jar | cut -f1)"

    - name: Prepare deploy directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=== 准备部署目录 ==="
          echo "当前时间: $(date)"
          echo "当前用户: $(whoami)"
          echo "当前目录: $(pwd)"
          echo "用户 ID: $(id)"
          
          # 检查 /opt 目录是否存在
          echo "检查 /opt 目录..."
          if [ ! -d "/opt" ]; then
            echo "⚠️  /opt 目录不存在，尝试创建..."
            sudo mkdir -p /opt || {
              echo "❌ 无法创建 /opt 目录"
              exit 1
            }
          else
            echo "✅ /opt 目录存在"
            ls -ld /opt
          fi
          
          # 创建部署目录
          echo "创建部署目录: /opt/blob-backend/deploy/"
          if [ ! -d "/opt/blob-backend/deploy" ]; then
            echo "目录不存在，正在创建..."
            sudo mkdir -p /opt/blob-backend/deploy || {
              echo "⚠️  sudo 创建失败，尝试使用当前用户权限..."
              mkdir -p /opt/blob-backend/deploy || {
                echo "❌ 无法创建目录 /opt/blob-backend/deploy"
                echo "请检查权限或手动创建目录"
                exit 1
              }
            }
            echo "✅ 目录创建成功"
          else
            echo "✅ 目录已存在"
          fi
          
          # 设置目录权限
          echo "设置目录权限..."
          sudo chown -R $(whoami):$(whoami) /opt/blob-backend/deploy || {
            echo "⚠️  设置权限失败，继续..."
          }
          sudo chmod 755 /opt/blob-backend/deploy || {
            echo "⚠️  设置权限失败，继续..."
          }
          
          # 创建日志目录
          echo "创建日志目录: /opt/blob-backend/logs/"
          sudo mkdir -p /opt/blob-backend/logs || {
            mkdir -p /opt/blob-backend/logs || {
              echo "⚠️  无法创建日志目录，继续..."
            }
          }
          sudo chown -R $(whoami):$(whoami) /opt/blob-backend/logs || true
          
          # 验证目录
          echo "=== 验证目录 ==="
          echo "部署目录信息:"
          ls -ld /opt/blob-backend/deploy
          echo "日志目录信息:"
          ls -ld /opt/blob-backend/logs
          echo "部署目录内容:"
          ls -lah /opt/blob-backend/deploy/ || echo "目录为空"
          echo "目录权限详情:"
          stat /opt/blob-backend/deploy || echo "无法获取目录信息"
          echo "✅ 目录准备完成"

    - name: Deploy to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "artifacts/BlobBackendService-1.0-SNAPSHOT.jar"
        target: "/opt/blob-backend/deploy/"
        strip_components: 0
        debug: true
        overwrite: true
        rm: true
        tar_tmp_path: /tmp

    - name: Verify file transfer
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=== 验证文件传输 ==="
          echo "检查 JAR 文件是否成功传输..."
          JAR_FILE="/opt/blob-backend/deploy/BlobBackendService-1.0-SNAPSHOT.jar"
          if [ -f "$JAR_FILE" ]; then
            echo "✅ JAR 文件传输成功"
            echo "文件信息:"
            ls -lh "$JAR_FILE"
            file "$JAR_FILE"
            echo "文件大小: $(du -h "$JAR_FILE" | cut -f1)"
            echo "文件权限: $(stat -c '%a %U:%G' "$JAR_FILE" 2>/dev/null || stat -f '%A %u:%g' "$JAR_FILE")"
          else
            echo "❌ JAR 文件传输失败: $JAR_FILE"
            echo "目标目录内容:"
            ls -lah /opt/blob-backend/deploy/ || echo "目录不存在或无法访问"
            echo "目录权限:"
            ls -ld /opt/blob-backend/deploy/ || echo "无法获取目录信息"
            exit 1
          fi

    - name: Deploy backend JAR
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=== 部署后端服务 ==="
          echo "当前时间: $(date)"
          echo "当前用户: $(whoami)"
          echo "当前目录: $(pwd)"
          
          # 设置 Java 环境变量
          echo "=== 设置 Java 环境 ==="
          if [ -d "/usr/lib/jvm/jdk-24.0.1" ]; then
            export JAVA_HOME=/usr/lib/jvm/jdk-24.0.1
            export PATH=$JAVA_HOME/bin:$PATH
            echo "✅ 使用 JDK 24.0.1"
          elif command -v java &> /dev/null; then
            echo "✅ 使用系统默认 Java"
            java -version
          else
            echo "❌ 未找到 Java 环境"
            exit 1
          fi
          
          echo "Java 路径: $(which java)"
          echo "Java 版本:"
          java -version
          
          # 停止现有服务
          echo "=== 停止现有服务 ==="
          if pgrep -f BlobBackendService > /dev/null; then
            echo "发现运行中的服务，正在停止..."
            pkill -f BlobBackendService || true
            sleep 3
            if pgrep -f BlobBackendService > /dev/null; then
              echo "⚠️  服务仍在运行，强制停止..."
              pkill -9 -f BlobBackendService || true
              sleep 2
            fi
            echo "✅ 服务已停止"
          else
            echo "✅ 没有运行中的服务"
          fi
          
          # 创建日志目录
          echo "=== 创建日志目录 ==="
          mkdir -p /opt/blob-backend/logs || {
            echo "⚠️  无法创建日志目录，尝试使用 sudo..."
            sudo mkdir -p /opt/blob-backend/logs || {
              echo "❌ 无法创建日志目录"
              exit 1
            }
            sudo chown -R $(whoami):$(whoami) /opt/blob-backend/logs || true
          }
          echo "✅ 日志目录已创建"
          
          # 检查 JAR 文件
          echo "=== 检查 JAR 文件 ==="
          JAR_FILE="/opt/blob-backend/deploy/BlobBackendService-1.0-SNAPSHOT.jar"
          if [ ! -f "$JAR_FILE" ]; then
            echo "❌ JAR 文件不存在: $JAR_FILE"
            echo "目录内容:"
            ls -lah /opt/blob-backend/deploy/ || echo "目录不存在或无法访问"
            exit 1
          fi
          
          echo "✅ JAR 文件存在"
          ls -lh "$JAR_FILE"
          file "$JAR_FILE"
          
          # 备份旧版本
          echo "=== 备份旧版本 ==="
          if [ -f "$JAR_FILE" ]; then
            BACKUP_FILE="${JAR_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
            cp "$JAR_FILE" "$BACKUP_FILE" && echo "✅ 备份完成: $BACKUP_FILE" || echo "⚠️  备份失败，继续部署"
          fi
          
          # 启动后端服务（端口 8081）
          echo "=== 启动后端服务（端口 8081）==="
          echo "JAR 文件: $JAR_FILE"
          echo "Java 路径: $(which java)"
          
          nohup java -Xms512m -Xmx1g \
            -Dspring.profiles.active=prod \
            -jar "$JAR_FILE" \
            > /opt/blob-backend/logs/app.log 2>&1 &
          
          PID=$!
          echo "服务进程 ID: $PID"
          
          # 等待服务启动
          echo "=== 等待服务启动 ==="
          sleep 10
          
          # 检查进程是否还在运行
          if ps -p $PID > /dev/null 2>&1; then
            echo "✅ 服务进程正在运行 (PID: $PID)"
          else
            echo "❌ 服务进程已退出，查看日志："
            tail -50 /opt/blob-backend/logs/app.log
            exit 1
          fi
          
          # 检查服务状态
          echo "=== 检查服务健康状态 ==="
          for i in {1..10}; do
            echo "尝试 $i/10..."
            if curl -s -f http://localhost:8081/api/health > /dev/null 2>&1; then
              echo "✅ 服务健康检查通过"
              curl -s http://localhost:8081/api/health | head -10
              break
            else
              if [ $i -eq 10 ]; then
                echo "❌ 服务健康检查失败"
                echo "查看日志："
                tail -50 /opt/blob-backend/logs/app.log
                echo "检查端口："
                netstat -tlnp | grep 8081 || ss -tlnp | grep 8081 || echo "端口 8081 未监听"
                exit 1
              fi
              sleep 2
            fi
          done
          
          echo ""
          echo "=== 部署完成 ==="
          echo "服务信息："
          echo "  JAR 文件: $JAR_FILE"
          echo "  进程 ID: $PID"
          echo "  日志文件: /opt/blob-backend/logs/app.log"
          echo "  健康检查: http://localhost:8081/api/health"

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=== 验证部署 ==="
          
          # 检查后端服务
          echo "检查后端服务（端口 8081）..."
          if curl -s http://localhost:8081/api/health > /dev/null 2>&1; then
            echo "✅ 后端服务运行正常"
            curl -s http://localhost:8081/api/health | head -5
          else
            echo "❌ 后端服务未响应"
          fi
          
          echo ""
          echo "=== 部署完成 ==="
          echo "后端地址: http://${{ secrets.SERVER_HOST }}:8081"
          echo "健康检查: http://${{ secrets.SERVER_HOST }}:8081/api/health"

